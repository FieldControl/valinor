{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/effects/migrations/18_0_0-beta/index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as ts from 'typescript';\nimport {\n  Tree,\n  Rule,\n  chain,\n  SchematicContext,\n} from '@angular-devkit/schematics';\nimport {\n  addPackageToPackageJson,\n  Change,\n  commitChanges,\n  createReplaceChange,\n  InsertChange,\n  visitTSSourceFiles,\n} from '../../schematics-core';\nimport { createRemoveChange } from '../../schematics-core/utility/change';\n\nexport function migrateConcatLatestFromImport(): Rule {\n  return (tree: Tree, ctx: SchematicContext) => {\n    const changes: Change[] = [];\n    addPackageToPackageJson(tree, 'dependencies', '@ngrx/operators', '^18.0.0');\n\n    visitTSSourceFiles(tree, (sourceFile) => {\n      const importDeclarations = new Array<ts.ImportDeclaration>();\n      getImportDeclarations(sourceFile, importDeclarations);\n\n      const effectsImportsAndDeclaration = importDeclarations\n        .map((effectsImportDeclaration) => {\n          const effectsImports = getEffectsNamedBinding(\n            effectsImportDeclaration\n          );\n          if (effectsImports) {\n            return { effectsImports, effectsImportDeclaration };\n          } else {\n            return undefined;\n          }\n        })\n        .find(Boolean);\n\n      if (!effectsImportsAndDeclaration) {\n        return;\n      }\n\n      const { effectsImports, effectsImportDeclaration } =\n        effectsImportsAndDeclaration;\n\n      const operatorsImportDeclaration = importDeclarations.find((node) =>\n        node.moduleSpecifier.getText().includes('@ngrx/operators')\n      );\n\n      const otherEffectsImports = effectsImports.elements\n        .filter((element) => element.name.getText() !== 'concatLatestFrom')\n        .map((element) => element.name.getText())\n        .join(', ');\n\n      // Remove `concatLatestFrom` from @ngrx/effects and leave the other imports\n      if (otherEffectsImports) {\n        changes.push(\n          createReplaceChange(\n            sourceFile,\n            effectsImportDeclaration,\n            effectsImportDeclaration.getText(),\n            `import { ${otherEffectsImports} } from '@ngrx/effects';`\n          )\n        );\n      }\n      // Remove complete @ngrx/effects import because it contains only `concatLatestFrom`\n      else {\n        changes.push(\n          createRemoveChange(\n            sourceFile,\n            effectsImportDeclaration,\n            effectsImportDeclaration.getStart(),\n            effectsImportDeclaration.getEnd() + 1\n          )\n        );\n      }\n\n      let importAppendedInExistingDeclaration = false;\n      if (operatorsImportDeclaration?.importClause?.namedBindings) {\n        const bindings = operatorsImportDeclaration.importClause.namedBindings;\n        if (ts.isNamedImports(bindings)) {\n          // Add import to existing @ngrx/operators\n          const updatedImports = [\n            ...bindings.elements.map((element) => element.name.getText()),\n            'concatLatestFrom',\n          ];\n          const newOperatorsImport = `import { ${updatedImports.join(\n            ', '\n          )} } from '@ngrx/operators';`;\n          changes.push(\n            createReplaceChange(\n              sourceFile,\n              operatorsImportDeclaration,\n              operatorsImportDeclaration.getText(),\n              newOperatorsImport\n            )\n          );\n          importAppendedInExistingDeclaration = true;\n        }\n      }\n\n      if (!importAppendedInExistingDeclaration) {\n        // Add new @ngrx/operators import line\n        const newOperatorsImport = `import { concatLatestFrom } from '@ngrx/operators';`;\n        changes.push(\n          new InsertChange(\n            sourceFile.fileName,\n            effectsImportDeclaration.getEnd() + 1,\n            `${newOperatorsImport}\\n`\n          )\n        );\n      }\n\n      commitChanges(tree, sourceFile.fileName, changes);\n\n      if (changes.length) {\n        ctx.logger.info(\n          `[@ngrx/effects] Updated concatLatestFrom to import from '@ngrx/operators'`\n        );\n      }\n    });\n  };\n}\n\nfunction getImportDeclarations(\n  node: ts.Node,\n  imports: ts.ImportDeclaration[]\n): void {\n  if (ts.isImportDeclaration(node)) {\n    imports.push(node);\n  }\n\n  ts.forEachChild(node, (childNode) =>\n    getImportDeclarations(childNode, imports)\n  );\n}\n\nfunction getEffectsNamedBinding(\n  node: ts.ImportDeclaration\n): ts.NamedImports | null {\n  const namedBindings = node?.importClause?.namedBindings;\n  if (\n    node.moduleSpecifier.getText().includes('@ngrx/effects') &&\n    namedBindings &&\n    ts.isNamedImports(namedBindings)\n  ) {\n    return namedBindings;\n  }\n\n  return null;\n}\n\nexport default function (): Rule {\n  return chain([migrateConcatLatestFromImport()]);\n}\n"]}