{"version":3,"sources":["nodeStream.ts"],"sourcesContent":["import { Readable as NodeReadableStream } from 'stream';\n\nconst hasIterator = typeof Symbol !== 'undefined' && Symbol.asyncIterator;\n\n/* c8 ignore start */\nexport default function nodeStreamIterator<T>(stream: NodeReadableStream): AsyncIterableIterator<T> {\n  let cleanup = null;\n  let error = null;\n  let done = false;\n  const data = [];\n  const waiting = [];\n\n  function onData(chunk) {\n    if (error) return;\n    if (waiting.length) return waiting.shift()[0]({ value: chunk, done: false });\n    data.push(chunk);\n  }\n  function onError(err) {\n    error = err;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[1](err);\n    });\n    !cleanup || cleanup();\n  }\n  function onEnd() {\n    done = true;\n    const all = waiting.slice();\n    all.forEach(function (pair) {\n      pair[0]({ value: undefined, done: true });\n    });\n    !cleanup || cleanup();\n  }\n\n  cleanup = function () {\n    cleanup = null;\n    stream.removeListener('data', onData);\n    stream.removeListener('error', onError);\n    stream.removeListener('end', onEnd);\n    stream.removeListener('finish', onEnd);\n    stream.removeListener('close', onEnd);\n  };\n  stream.on('data', onData);\n  stream.on('error', onError);\n  stream.on('end', onEnd);\n  stream.on('finish', onEnd);\n  stream.on('close', onEnd);\n\n  function getNext(): Promise<IteratorResult<T, boolean>> {\n    return new Promise(function (resolve, reject) {\n      if (error) return reject(error);\n      if (data.length) return resolve({ value: data.shift(), done: false });\n      if (done) return resolve({ value: undefined, done: true });\n      waiting.push([resolve, reject]);\n    });\n  }\n\n  const iterator = {\n    next(): Promise<IteratorResult<T, boolean>> {\n      return getNext();\n    },\n  };\n\n  if (hasIterator) {\n    iterator[Symbol.asyncIterator] = function (): AsyncIterator<T> {\n      return this;\n    };\n  }\n\n  return iterator as AsyncIterableIterator<T>;\n}\n/* c8 ignore stop */\n"],"names":["hasIterator","Symbol","asyncIterator","nodeStreamIterator","stream","cleanup","error","done","data","waiting","onData","chunk","length","shift","value","push","onError","err","all","slice","forEach","pair","onEnd","undefined","removeListener","on","getNext","Promise","resolve","reject","iterator","next"],"mappings":"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"}