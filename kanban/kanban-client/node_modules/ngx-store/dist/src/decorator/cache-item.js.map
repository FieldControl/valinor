{"version":3,"sources":["../../../src/decorator/cache-item.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,WAAW,CAAC;AAE1C,OAAO,EAAE,KAAK,EAAE,MAAM,SAAS,CAAC;AAUhC;IAUI,mBAAY,SAA6B;QATlC,SAAI,GAAW,EAAE,CAAC;QAClB,YAAO,GAAkB,EAAE,CAAC;QAC5B,aAAQ,GAAsC,EAAE,CAAC;QACjD,cAAS,GAA6B,EAAE,CAAC;QAEtC,UAAK,GAAQ,IAAI,CAAC;QAClB,SAAI,GAAW,EAAE,CAAC;QAClB,uBAAkB,GAAgB,IAAI,GAAG,EAAE,CAAC;QAGlD,IAAI,CAAC,IAAI,GAAG,SAAS,CAAC,GAAG,CAAC;QAC1B,IAAI,CAAC,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC;QAC3B,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QACnC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;QACrC,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;IAC3C,CAAC;IAED,sBAAW,0BAAG;aAAd;YACI,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC;QACrB,CAAC;;;OAAA;IAEM,6BAAS,GAAhB,UAAiB,KAAU,EAAE,MAA4B;QAAzD,iBAqBC;QArB4B,uBAAA,EAAA,WAA4B;QACrD,KAAK,CAAC,cAAc,CAAC,0BAA0B,GAAG,IAAI,CAAC,GAAG,GAAG,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAC3G,KAAK,CAAC,GAAG,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;QAChC,KAAK,CAAC,GAAG,CAAC,kBAAkB,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC;QACtD,KAAK,CAAC,GAAG,CAAC,kBAAkB,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;QACnD,KAAK,CAAC,GAAG,CAAC,gBAAgB,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;QAChD,KAAK,CAAC,QAAQ,EAAE,CAAC;QAEjB,8CAA8C;QAC9C,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;YACnD,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;YAChD,IAAI,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;YACvC,IAAI,YAAU,GAAG,CAAC,SAAS,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC;YAC1D,IAAI,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,YAAU,EAAE,MAAM,CAAC,CAAC;YAC9C,KAAK,GAAG,CAAC,KAAK,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC;YACzC,KAAK,CAAC,GAAG,CAAC,oBAAoB,GAAG,IAAI,CAAC,GAAG,GAAG,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;YACjG,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,GAAG,CAAC,KAAI,CAAC,IAAI,EAAE,YAAU,EAAE,MAAM,CAAC,EAA1C,CAA0C,CAAC,CAAC;YAC9E,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC;QACD,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,GAAG,CAAC,KAAI,CAAC,IAAI,EAAE,KAAK,EAAE,MAAM,CAAC,EAArC,CAAqC,CAAC,CAAC;QACzE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;IACxC,CAAC;IAEM,4BAAQ,GAAf,UAAgB,KAAW,EAAE,MAA4B;QAA5B,uBAAA,EAAA,WAA4B;QACrD,EAAE,CAAC,CAAC,KAAK,KAAK,SAAS,IAAI,IAAI,CAAC,KAAK,CAAC;YAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,8CAA8C;QACxG,KAAK,GAAG,CAAC,KAAK,KAAK,SAAS,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;QAC/D,EAAE,CAAC,CAAC,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,KAAK,IAAI,CAAC,CAAC,CAAC;YAC9C,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;YACnB,MAAM,CAAC,KAAK,CAAC;QACjB,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,MAAM,KAAK,KAAK,CAAC;YAAC,MAAM,CAAC,KAAK,CAAC;QAEvF,IAAI,KAAK,GAAG,IAAI,CAAC,CAAC,gDAAgD;QAClE,IAAI,SAAS,GAAQ,MAAM,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,WAAW,EAAE,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;QAE7E,SAAS,CAAC,IAAI,GAAG;YACb,KAAK,CAAC,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;QACnC,CAAC,CAAC;QAEF,sDAAsD;QACtD,EAAE,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;YACvB,IAAM,kBAAkB,GAAG;gBACvB,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE,QAAQ;gBACtD,QAAQ,EAAE,SAAS,EAAE,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,YAAY;aAC3D,CAAC;oCACO,MAAM;gBACX,SAAS,CAAC,MAAM,CAAC,GAAG;oBAChB,IAAI,KAAK,GAAG,KAAK,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;oBACpC,IAAI,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,KAAK,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC;oBAC7D,KAAK,CAAC,GAAG,CAAC,mBAAmB,GAAG,KAAK,CAAC,GAAG,GAAG,aAAa,GAAG,SAAS,CAAC,WAAW,CAAC,IAAI,GAAG,GAAG,GAAG,MAAM,CAAC,CAAC;oBACvG,KAAK,CAAC,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;oBAC/B,MAAM,CAAC,MAAM,CAAC;gBAClB,CAAC,CAAA;YACL,CAAC;YARD,GAAG,CAAC,CAAe,UAAkB,EAAlB,yCAAkB,EAAlB,gCAAkB,EAAlB,IAAkB;gBAAhC,IAAI,MAAM,2BAAA;wBAAN,MAAM;aAQd;QACL,CAAC;QACD,MAAM,CAAC,cAAc,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC;QACxC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,MAAM,CAAC,KAAK,CAAC;IACjB,CAAC;IAEM,6BAAS,GAAhB,UAAiB,MAA4B;QAA7C,iBAQC;QARgB,uBAAA,EAAA,WAA4B;QACzC,IAAI,KAAK,GAAG,IAAI,CAAC;QACjB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,UAAA,OAAO;YAC1B,EAAE,CAAC,CAAC,KAAK,KAAK,IAAI,CAAC,CAAC,CAAC;gBACjB,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,KAAI,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;YAC3C,CAAC;QACL,CAAC,CAAC,CAAC;QACH,MAAM,CAAC,CAAC,OAAO,KAAK,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;IAC1G,CAAC;IAEM,8BAAU,GAAjB,UAAkB,OAAmB;QAArC,iBA+BC;QA9BG,OAAO,CAAC,OAAO,CAAC,UAAA,MAAM;YAClB,EAAE,CAAC,CAAC,KAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;gBACtC,EAAE,CAAC,CAAC,OAAO,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC;oBAC7B,IAAI,kBAAgB,GAAG,MAAM,CAAC,WAAW,CAAC;oBAC1C,IAAI,OAAK,GAAG,KAAI,CAAC;oBACjB,MAAM,CAAC,WAAW,GAAG;wBACjB,EAAE,CAAC,CAAC,OAAO,kBAAgB,KAAK,UAAU,CAAC,CAAC,CAAC;4BACzC,kBAAgB,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;wBAC5C,CAAC;wBACD,MAAM,CAAC,WAAW,GAAG,kBAAgB,IAAI,cAAW,CAAC,CAAC;wBAEtD,OAAK,CAAC,kBAAkB,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;wBACxC,OAAK,CAAC,OAAO,GAAG,OAAK,CAAC,OAAO,CAAC,MAAM,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,KAAK,MAAM,EAAZ,CAAY,CAAC,CAAC;wBACxD,EAAE,CAAC,CAAC,CAAC,OAAK,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;4BACxB,OAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAA,OAAO;gCAC1B,OAAO,CAAC,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,UAAA,GAAG,IAAI,OAAA,GAAG,KAAK,OAAK,CAAC,IAAI,EAAlB,CAAkB,CAAC,CAAC;4BAClE,CAAC,CAAC,CAAC;4BACH,OAAK,CAAC,UAAU,EAAE,CAAC;4BACnB,KAAK,CAAC,MAAM,CAAC,OAAK,CAAC,CAAC;wBACxB,CAAC;wBACD,KAAK,CAAC,cAAc,CAAI,OAAK,CAAC,GAAG,wBAAqB,CAAC,CAAC;wBACxD,KAAK,CAAC,GAAG,CAAC,iBAAiB,EAAE,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;wBACtD,KAAK,CAAC,GAAG,CAAC,oBAAoB,EAAE,OAAK,CAAC,OAAO,CAAC,CAAC;wBAC/C,KAAK,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,GAAG,CAAC,OAAK,CAAC,GAAG,CAAC,CAAC,CAAC;wBAC9C,KAAK,CAAC,QAAQ,EAAE,CAAC;oBACrB,CAAC,CAAC;oBACF,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC9B,CAAC;YACL,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,+BAAW,GAAlB,UAAmB,QAA2C;QAA9D,iBAOC;QANG,QAAQ,CAAC,OAAO,CAAC,UAAA,OAAO;YACpB,EAAE,CAAC,CAAC,KAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;gBACxC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,KAAI,CAAC,IAAI,CAAC,CAAC;gBAC7B,KAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAChC,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,gCAAY,GAAnB,UAAoB,SAAmC;QAAvD,iBAMC;QALG,SAAS,CAAC,OAAO,CAAC,UAAA,OAAO;YACrB,EAAE,CAAC,CAAC,KAAI,CAAC,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;gBACzC,KAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACjC,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,8BAAU,GAAjB;QACI,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;IACtB,CAAC;IACL,gBAAC;AAAD,CAjJA,AAiJC,IAAA","file":"cache-item.js","sourceRoot":"","sourcesContent":["import { WebStorageServiceInterface } from '../service';\nimport { WebStorageUtility } from '../utility/webstorage-utility';\nimport { Config, debug } from '../config';\nimport { DecoratorConfig } from './webstorage';\nimport { Cache } from './cache';\n\nexport interface CacheItemInterface {\n    key: string;\n    name: string;\n    targets: Array<Object>;\n    services: Array<WebStorageServiceInterface>;\n    utilities: Array<WebStorageUtility>;\n}\n\nexport class CacheItem implements CacheItemInterface {\n    public name: string = '';\n    public targets: Array<Object> = [];\n    public services: Array<WebStorageServiceInterface> = [];\n    public utilities: Array<WebStorageUtility> = [];\n    public currentTarget: Object;\n    protected proxy: any = null;\n    protected _key: string = '';\n    protected initializedTargets: Set<Object> = new Set();\n\n    constructor(cacheItem: CacheItemInterface) {\n        this._key = cacheItem.key;\n        this.name = cacheItem.name;\n        this.addTargets(cacheItem.targets);\n        this.addServices(cacheItem.services);\n        this.addUtilities(cacheItem.utilities);\n    }\n\n    public get key() {\n        return this._key;\n    }\n\n    public saveValue(value: any, config: DecoratorConfig = {}): any {\n        debug.groupCollapsed('CacheItem#saveValue for ' + this.key + ' in ' + this.currentTarget.constructor.name);\n        debug.log('new value: ', value);\n        debug.log('previous value: ', this.readValue(config));\n        debug.log('targets.length: ', this.targets.length);\n        debug.log('currentTarget:', this.currentTarget);\n        debug.groupEnd();\n\n        // prevent overwriting value by initializators\n        if (!this.initializedTargets.has(this.currentTarget)) {\n            this.initializedTargets.add(this.currentTarget);\n            let readValue = this.readValue(config);\n            let savedValue = (readValue !== null) ? readValue : value;\n            let proxy = this.getProxy(savedValue, config);\n            proxy = (proxy !== null) ? proxy : value;\n            debug.log('initial value for ' + this.key + ' in ' + this.currentTarget.constructor.name, proxy);\n            this.utilities.forEach(utility => utility.set(this._key, savedValue, config));\n            return proxy;\n        }\n        this.utilities.forEach(utility => utility.set(this._key, value, config));\n        return this.getProxy(value, config);\n    }\n\n    public getProxy(value?: any, config: DecoratorConfig = {}): any {\n        if (value === undefined && this.proxy) return this.proxy; // return cached proxy if value hasn't changed\n        value = (value === undefined) ? this.readValue(config) : value;\n        if (typeof value !== 'object' || value === null) {\n            this.proxy = value;\n            return value;\n        }\n        if ((!Config.mutateObjects && !config.mutate) || config.mutate === false) return value;\n\n        let _self = this; // alias to use in standard function expressions\n        let prototype: any = Object.assign(new value.constructor(), value.__proto__);\n\n        prototype.save = function () { // add method for triggering force save\n            _self.saveValue(value, config);\n        };\n\n        // TODO set prototype for Array.prototype or something\n        if (Array.isArray(value)) { // handle methods that could change value of array\n            const methodsToOverwrite = [\n                'pop', 'push', 'reverse', 'shift', 'unshift', 'splice',\n                'filter', 'forEach', 'map', 'fill', 'sort', 'copyWithin'\n            ];\n            for (let method of methodsToOverwrite) {\n                prototype[method] = function () {\n                    let value = _self.readValue(config);\n                    let result = Array.prototype[method].apply(value, arguments);\n                    debug.log('Saving value for ' + _self.key + ' by method ' + prototype.constructor.name + '.' + method);\n                    _self.saveValue(value, config);\n                    return result;\n                }\n            }\n        }\n        Object.setPrototypeOf(value, prototype);\n        this.proxy = value;\n        return value;\n    }\n\n    public readValue(config: DecoratorConfig = {}): any {\n        let value = null;\n        this.utilities.forEach(utility => {\n            if (value === null) {\n                value = utility.get(this._key, config);\n            }\n        });\n        return (typeof value !== 'object') ? value : JSON.parse(JSON.stringify(this.getProxy(value, config)));\n    }\n\n    public addTargets(targets: Array<any>): void {\n        targets.forEach(target => {\n            if (this.targets.indexOf(target) === -1) {\n                if (typeof target === 'object') { // handle Angular Component destruction\n                    let originalFunction = target.ngOnDestroy;\n                    let _self = this;\n                    target.ngOnDestroy = function() {\n                        if (typeof originalFunction === 'function') {\n                            originalFunction.apply(this, arguments);\n                        }\n                        target.ngOnDestroy = originalFunction || function(){};\n\n                        _self.initializedTargets.delete(target);\n                        _self.targets = _self.targets.filter(t => t !== target);\n                        if (!_self.targets.length) {\n                            _self.services.forEach(service => {\n                                service.keys = service.keys.filter(key => key !== _self._key);\n                            });\n                            _self.resetProxy();\n                            Cache.remove(_self);\n                        }\n                        debug.groupCollapsed(`${_self.key} OnDestroy handler:`);\n                        debug.log('removed target:', target.constructor.name);\n                        debug.log('remaining targets:', _self.targets);\n                        debug.log('cacheItem:', Cache.get(_self.key));\n                        debug.groupEnd();\n                    };\n                    this.targets.push(target);\n                }\n            }\n        });\n    }\n\n    public addServices(services: Array<WebStorageServiceInterface>): void {\n        services.forEach(service => {\n            if (this.services.indexOf(service) === -1) {\n                service.keys.push(this._key);\n                this.services.push(service);\n            }\n        });\n    }\n\n    public addUtilities(utilities: Array<WebStorageUtility>): void {\n        utilities.forEach(utility => {\n            if (this.utilities.indexOf(utility) === -1) {\n                this.utilities.push(utility);\n            }\n        });\n    }\n\n    public resetProxy(): void {\n        this.proxy = null;\n    }\n}\n"]}